---
parameters:
  name: null
  vmImage: 'ubuntu-16.04'
  publishresults: False
  toxargs: ''
  toxenv: {}

jobs:
- job: ${{ parameters.name }}
  pool:
    vmImage: ${{ parameters.vmImage }}
  strategy:
    matrix:
      ${{ each env in parameters.toxenv }}:
        ${{ env.key }}:
          TOXENV: ${{ env.value }}

  steps:
  - script: 'docker-compose --file tests/docker-compose.yml build'
    displayName: 'Build container'
  - script: |
      export TOXENV="py${PY_VER//.}"
      docker-compose --file tests/docker-compose.yml run tox ${{ parameters.toxargs }}
    displayName: 'Run Tox'

  - task: PublishTestResults@2
    condition: ${{ parameters.publishresults }}
    inputs:
      testResultsFiles: '**/test-*.xml'
      testRunTitle: 'Publish test results for Python $(python.version)'
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'